<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ぴにょぐらむ撮影会 | Pinyogram - イベントスケジュール・予約システム</title>
    
    <!-- SEO最適化メタタグ -->
    <meta name="description" content="ぴにょぐらむ（Pinyogram）撮影会のイベントスケジュール・予約システム。個人撮影会・団体撮影会の最新情報、カレンダー表示、オンライン予約が可能。写真愛好家のための撮影会プラットフォームです。">
    <meta name="keywords" content="ぴにょぐらむ, pinyogram, 撮影会, 写真撮影会, 個人撮影会, 団体撮影会, イベントスケジュール, 撮影会予約, 写真イベント, カメラマン, モデル撮影, 撮影会カレンダー">
    <meta name="author" content="Pinyogram">
    <meta name="robots" content="index, follow">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D3J45W8YXL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-D3J45W8YXL');
    </script>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pinyogram.com/event/">
    <meta property="og:title" content="ぴにょぐらむ撮影会 | Pinyogram - イベントスケジュール・予約システム">
    <meta property="og:description" content="ぴにょぐらむ（Pinyogram）撮影会のイベントスケジュール・予約システム。個人撮影会・団体撮影会の最新情報、カレンダー表示、オンライン予約が可能。">
    <meta property="og:image" content="https://images.pinyogram.com/home/0916.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="ぴにょぐらむ撮影会イベントスケジュール">
    <meta property="og:site_name" content="ぴにょぐらむ撮影会">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://pinyogram.com/event/">
    <meta name="twitter:title" content="ぴにょぐらむ撮影会 | Pinyogram - イベントスケジュール・予約システム">
    <meta name="twitter:description" content="ぴにょぐらむ（Pinyogram）撮影会のイベントスケジュール・予約システム。個人撮影会・団体撮影会の最新情報、カレンダー表示、オンライン予約が可能。">
    <meta name="twitter:image" content="https://images.pinyogram.com/home/0916.png">
    <meta name="twitter:image:alt" content="ぴにょぐらむ撮影会イベントスケジュール">
    
    <!-- 構造化データ（JSON-LD） -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Event",
      "name": "ぴにょぐらむ撮影会イベント",
      "description": "写真撮影会イベントのスケジュールと予約システム。個人撮影会・団体撮影会の情報提供。",
      "url": "https://pinyogram.com/event/",
      "image": "https://images.pinyogram.com/home/0916.png",
      "organizer": {
        "@type": "Organization",
        "name": "ぴにょぐらむ撮影会",
        "alternateName": "Pinyogram",
        "url": "https://pinyogram.com"
      },
      "eventStatus": "https://schema.org/EventScheduled",
      "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
      "location": {
        "@type": "Place",
        "name": "撮影会会場",
        "address": {
          "@type": "PostalAddress",
          "addressCountry": "JP"
        }
      },
      "offers": {
        "@type": "Offer",
        "availability": "https://schema.org/InStock",
        "price": "0",
        "priceCurrency": "JPY"
      }
    }
    </script>
    
    <link rel="canonical" href="https://pinyogram.com/event/">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/shared/style.css?v=11.1.0">
    
    <!-- ヒーロー画像のプリロード -->
    <link rel="preload" as="image" href="https://images.pinyogram.com/home/0916.png">
    
    <!-- ファビコン -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23007AFF'/><circle cx='50' cy='50' r='30' fill='white'/></svg>">
</head>

<body>
    <!-- 共有ヘッダー -->
    <div id="site-header"></div>
    <!-- ヒーローセクション -->
<section class="hero-shell hero--md">
    <figure class="hero-frame fill-gradient img-100" style="--hero-aspect: 40/21;" data-pos="center">
        <img id="heroImg1" src="" alt="EVT004セッション撮影会2025/09/16 - クリックして詳細を表示" loading="lazy" decoding="async">
        <div class="media-overlay">
            <a href="/event/EVT004/" class="hero-link" aria-label="EVT004セッション撮影会2025/09/16の詳細ページへ移動"></a>
        </div>
    </figure>
</section>

<!-- メインコンテナ（既存） -->
<div class="main-container">
    <!-- 既存のコンテンツ -->
</div>

    
    <div class="main-container">
        <!-- 左側：イベント一覧（2/3） -->
        <div class="events-section">
            <h2 class="section-title">📸 ぴにょぐらむ撮影会 - 開催予定イベント</h2>
            <div class="events-grid" id="eventsGrid">
                <!-- イベントカードは動的に生成されます -->
            </div>
        </div>
        
        <!-- 右側：月間カレンダー（1/3） -->
        <div class="calendar-section">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3 class="calendar-title" id="calendarTitle">2025年8月</h3>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‹</button>
                        <button onclick="changeMonth(1)">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar">
                    <!-- カレンダーは動的生成 -->
                </div>
            </div>
            
            <!-- イベントリスト -->
            <div class="event-list" id="eventList">
                <h4 class="event-list-title">🗓 ぴにょぐらむ撮影会 - 今月のスケジュール</h4>
                <!-- イベントリストアイテムは動的に生成されます -->
            </div>
        </div>
    </div>

    <script>
        let eventData = [];

        async function loadEvents() {
            try {
                const res = await fetch('data/events.json');
                const json = await res.json();
                const list = json.events || json;
                eventData = (list || []).map(ev => ({
                    id: ev.event_id,
                    name: ev.event_name,
                    date: ev.event_date,
                    venue: ev.venue?.venue_name || '-',
                    price: ev.pricing?.perUnit || ev.pricing?.base_price || 0,
                    type: ev.event_type || 'group',
                    badge: ev.is_limited ? 'limited' : undefined,
                    remaining: ev.remaining_slots,
                    pricing: ev.pricing,
                    slug: ev.slug || ev.event_name
                }));
            } catch (e) {
                console.error('Failed to load events:', e);
            }
        }

        // イベントカードを生成
        function generateEventCards() {
            const eventsGrid = document.getElementById('eventsGrid');
            let html = '';
            
            eventData.forEach(event => {
                const date = new Date(event.date);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                
                let badgeHtml = '';
                if (event.badge === 'new') {
                    badgeHtml = '<span class="event-badge badge-new">NEW</span>';
                } else if (event.badge === 'popular') {
                    badgeHtml = '<span class="event-badge badge-popular">人気</span>';
                } else if (event.badge === 'limited') {
                    badgeHtml = '<span class="event-badge badge-limited">限定</span>';
                }
                
                const gradient = event.type === 'individual' 
                    ? 'linear-gradient(135deg, #10b981, #3b82f6)'
                    : 'linear-gradient(135deg, #ff6ec7, #3b82f6)';
                
                html += `
                    <div class="event-card" data-id="${event.id}" role="button" tabindex="0" aria-label="${event.name}の詳細ページへ移動">
                        <figure class="media-frame is-40x21 fill-gradient" data-focal="center" style="--bg: url('${event.image}')">
                            <img src="${event.image}" alt="${event.name}の画像" loading="lazy" decoding="async" ${event.id === 'EVT004' || event.event_id === 'EVT004' ? 'onload="console.log(\'✅ EVT004 image loaded successfully:\', this.src)" onerror="console.error(\'❌ EVT004 image failed to load:\', this.src); this.style.display=\'none\'; this.parentElement.className=\'media-frame is-40x21 fill-gradient\'; this.parentElement.innerHTML=\'<div style=\\\'color: white; text-align: center;\\\'>📷<br/>画像読み込み中...</div>\'"' : 'onerror="window.__imgFallback(this)"'} data-fallbacks="${event.__cardFallbacks ? event.__cardFallbacks.join(',') : ''}">
                            <div class="media-overlay">
                                ${badgeHtml}
                            </div>
                        </figure>
                        <div class="event-content">
                            <h3 class="event-title">${event.name}</h3>
                            <div class="event-info">📅 ${month}月${day}日(${dayOfWeek})</div>
                            <div class="event-info">📍 ${event.venue}</div>
                        </div>
                        <div class="event-footer">
                            <span class="event-price">${event.priceText ? event.priceText : `¥${(event.price||0).toLocaleString()}${event.type === 'individual' ? '/30分' : '〜'}`}</span>
                            <span style="color: #666; font-size: 0.85rem;">
                                ${event.remaining ? `残り${event.remaining}枠` : '空きあり'}
                            </span>
                        </div>
                        ${event.pricing ? `
                        <div class=\"price-breakdown\" style=\"padding:6px 12px; color:#555; font-size:0.85rem;\">
                            各部 ${'¥'+Number(event.pricing.perUnit).toLocaleString()} / 2部通し ${'¥'+Number(event.pricing.twoParts).toLocaleString()} / 3部通し ${'¥'+Number(event.pricing.threeParts).toLocaleString()}
                        </div>` : ''}
                        <div class="card-actions">
                            <a href="/event/${event.id}/" class="btn-detail">詳細を見る</a>
                        </div>
                    </div>
                `;
            });
            
            eventsGrid.innerHTML = html;
            
            // イベントカード全体にクリックイベントを追加
            document.querySelectorAll('.event-card').forEach(card => {
                const handleCardClick = (e) => {
                    if (e.target.classList.contains('btn-detail') || e.target.closest('.btn-detail')) {
                        return;
                    }
                    const eventId = card.dataset.id;
                    window.location.href = `/event/${eventId}/`;
                };
                card.addEventListener('click', handleCardClick);
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleCardClick(e);
                    }
                });
                card.style.cursor = 'pointer';
            });
        }
        
        // イベントリストを生成
        function generateEventList() {
            const eventList = document.getElementById('eventList');
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            let html = `<h4 class="event-list-title">🗓 ${currentYear}年${monthNames[currentMonth - 1]}のスケジュール</h4>`;
            
            // 現在表示中の月のイベントのみをフィルタリング
            const currentMonthEvents = eventData.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getFullYear() === currentYear && eventDate.getMonth() + 1 === currentMonth;
            });
            
            if (currentMonthEvents.length === 0) {
                html += '<div class="event-list-item no-events">この月のイベントはありません</div>';
            } else {
                currentMonthEvents.forEach(event => {
                    const date = new Date(event.date);
                    const day = date.getDate();
                    const typeText = event.type === 'individual' ? '個人撮影会' : '団体撮影会';
                    
                    html += `
                        <div class="event-list-item" data-id="${event.id}">
                            <div class="event-list-date">${day}</div>
                            <div class="event-list-info">
                                <div class="event-list-name">${event.name}</div>
                                <div class="event-list-type">${typeText}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            eventList.innerHTML = html;
            
            document.querySelectorAll('.event-list-item').forEach(item => {
                if (!item.classList.contains('no-events')) {
                    item.addEventListener('click', () => {
                        const eventId = item.dataset.id;
                        location.href = `/event/${eventId}/`;
                    });
                }
            });
        }
        
        // カレンダー生成
        let currentYear = 2025;
        let currentMonth = 8;
        
        // 現在の日付から最も近いイベントがある月を取得
        function getNearestEventMonth() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentDate = today.getDate();
            
            // 未来のイベントのみをフィルタリング
            const futureEvents = eventData.filter(event => {
                const eventDate = new Date(event.date);
                const todayDate = new Date(currentYear, currentMonth - 1, currentDate);
                return eventDate >= todayDate;
            });
            
            if (futureEvents.length === 0) {
                // 未来のイベントがない場合は現在の月を返す
                return { year: currentYear, month: currentMonth };
            }
            
            // 日付順にソート
            futureEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 最も近いイベントの月を取得
            const nearestEvent = futureEvents[0];
            const nearestEventDate = new Date(nearestEvent.date);
            const nearestYear = nearestEventDate.getFullYear();
            const nearestMonth = nearestEventDate.getMonth() + 1;
            
            return { year: nearestYear, month: nearestMonth };
        }
        
        function generateCalendar(year, month) {
            const calendar = document.getElementById('calendar');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const prevLastDay = new Date(year, month - 1, 0);
            
            const startingDayOfWeek = firstDay.getDay();
            const monthLength = lastDay.getDate();
            const prevMonthLength = prevLastDay.getDate();
            
            let html = '';
            
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                html += `<div class="calendar-weekday">${day}</div>`;
            });
            
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${prevMonthLength - i}</div>
                </div>`;
            }
            
            const today = new Date();
            for (let day = 1; day <= monthLength; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = eventData.filter(e => e.date === dateStr);
                const isToday = today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === day;
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (dayEvents.length > 0) dayClass += ' has-event';
                
                html += `<div class="${dayClass}">
                    <div class="calendar-day-number">${day}</div>`;
                
                const maxEvents = 3;
                const displayEvents = dayEvents.slice(0, maxEvents);
                
                displayEvents.forEach(event => {
                    const shortName = event.name.length > 6 ? event.name.substring(0, 6) + '...' : event.name;
                    html += `<div class="calendar-event ${event.type}">${shortName}</div>`;
                });
                
                if (dayEvents.length > maxEvents) {
                    const remainingCount = dayEvents.length - maxEvents;
                    html += `<div class="calendar-event more-events">+${remainingCount}</div>`;
                }
                
                html += '</div>';
            }
            
            const totalCells = startingDayOfWeek + monthLength;
            const nextMonthDays = 42 - totalCells;
            for (let day = 1; day <= nextMonthDays; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            calendar.innerHTML = html;
            
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const calendarTitle = document.getElementById('calendarTitle');
            if (calendarTitle) {
                calendarTitle.textContent = `${year}年${monthNames[month - 1]}`;
            }
        }
        
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            generateCalendar(currentYear, currentMonth);
            generateEventList(); // イベントリストも更新
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            await loadEvents();

            // 画像設定読込（Cloudflare構成対応）
            const fallbackHero = 'https://placehold.co/1920x1080/png?text=Pinyogram';
            const fallbackCard = 'https://placehold.co/800x600/png?text=Event';
            
            // 指定されたヒーロー画像URLを設定
            const heroImageUrl = 'https://images.pinyogram.com/home/0916.png';
            
            console.log('🖼️ Setting hero image:', {
                heroImageUrl: heroImageUrl
            });
            
            // ヒーロー画像を設定（3つのスライドすべてに同じ画像を適用）
            ['heroImg1','heroImg2','heroImg3'].forEach(id => { 
                const el = document.getElementById(id); 
                if (el) {
                    el.src = heroImageUrl;
                    el.alt = 'EVT004セッション撮影会2025/09/16 - クリックして詳細を表示';
                    
                    // 画像読み込みエラーハンドリング
                    el.onerror = function() {
                        console.warn('⚠️ Hero image failed to load, using fallback:', heroImageUrl);
                        this.src = fallbackHero;
                        this.alt = 'ぴにょぐらむ撮影会 - フォールバック画像';
                    };
                    
                    // 画像読み込み成功時のログ
                    el.onload = function() {
                        console.log('✅ Hero image loaded successfully:', heroImageUrl);
                    };
                }
            });

            // ヒーロー画像のクリックイベントを追加
            const heroLink = document.querySelector('.hero-frame .media-overlay .hero-link');
            if (heroLink) {
                console.log('🔗 Hero link found, adding click event');
                heroLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🎯 Hero image clicked, navigating to EVT004');
                    window.location.href = '/event/EVT004/';
                });
                
                // ヒーロー画像全体にもクリックイベントを追加（保険）
                const heroFrame = document.querySelector('.hero-frame');
                if (heroFrame) {
                    heroFrame.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'A') {
                            console.log('🎯 Hero frame clicked, navigating to EVT004');
                            window.location.href = '/event/EVT004/';
                        }
                    });
                    heroFrame.style.cursor = 'pointer';
                }
            } else {
                console.warn('⚠️ Hero link not found');
            }

            // ヒーローバンドの背景URL設定機能
            function applyBg(band) {
                const img = band.querySelector('img');
                if (!img) return;
                const url = 'url("' + (img.currentSrc || img.src) + '")';
                band.style.setProperty('--bg', url);
                console.log('🎨 Applied background URL to hero-band:', url);
            }

            // すべてのヒーローバンドに背景URLを適用
            document.querySelectorAll('.hero-band').forEach(band => {
                const img = band.querySelector('img');
                if (!img) return;

                // 初期反映
                if (img.complete) {
                    applyBg(band);
                } else {
                    img.addEventListener('load', () => applyBg(band), { once: true });
                }

                // 画像差し替え（スライダー等）にも追随
                new MutationObserver(() => applyBg(band))
                    .observe(img, { attributes: true, attributeFilter: ['src', 'srcset'] });
            });
            // 各イベントのカード画像に拡張子フォールバック（jpg/png/webp）
            const cacheBuster = '?v=' + Date.now();
            eventData.forEach(e => {
                let slug = e.slug || e.name;
                // イベント詳細ページと同じスラッグ処理を適用
                if (slug && slug.includes('/')) {
                    slug = slug.replace(/\//g, ':');
                }
                
                console.log('🎴 Processing card image for event:', {
                    eventName: e.event_name || e.name,
                    originalSlug: e.slug,
                    processedSlug: slug
                });
                
                // EVT004の場合は提供されたURLを直接使用
                if (e.id === 'EVT004' || e.event_id === 'EVT004') {
                    const directUrl = 'https://images.pinyogram.com/events/%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E6%92%AE%E5%BD%B1%E4%BC%9A2025:09:16/main/hero.png';
                    e.image = directUrl + cacheBuster;
                    e.__cardFallbacks = []; // フォールバックなし（直接URL使用）
                    console.log('🎴 Using direct URL for EVT004:', directUrl);
                } else if (window.getEventAssetUrlCandidates) {
                    // その他のイベントは従来の処理
                    const cands = window.getEventAssetUrlCandidates(slug, 'main', 'hero', ['png','jpg','webp']);
                    console.log('🎴 Generated card image URLs:', {
                        eventName: e.event_name || e.name,
                        slug,
                        candidates: cands,
                        selectedUrl: cands[0]
                    });
                    e.image = (cands[0] || fallbackCard) + cacheBuster;
                    e.__cardFallbacks = cands.slice(1).map(url => url + cacheBuster);
                } else {
                    const url = window.getEventAssetUrl ? window.getEventAssetUrl(slug, 'main', 'hero.png') : (window.APP_IMAGE && window.APP_IMAGE.event);
                    console.log('🎴 Generated single card image URL:', {
                        eventName: e.event_name || e.name,
                        slug,
                        url
                    });
                    e.image = (url || fallbackCard) + cacheBuster;
                }
            });

            generateEventCards();
            generateEventList();
            
            // 最も近いイベントがある月を取得してカレンダーを初期化
            const nearestEventMonth = getNearestEventMonth();
            currentYear = nearestEventMonth.year;
            currentMonth = nearestEventMonth.month;
            
            console.log('📅 Initializing calendar with nearest event month:', {
                year: currentYear,
                month: currentMonth,
                events: eventData.length
            });
            
            generateCalendar(currentYear, currentMonth);
        });
    </script>

    <!-- 共有フッター -->
    <div id="site-footer"></div>

    <!-- JavaScript (ES6 Modules) -->
    <script src="../shared/js/config.js"></script>
    <script type="module" src="js/shared/main.js"></script>
    <script defer src="../shared/header.js"></script>
    <script defer src="../shared/footer.js"></script>
    
    <!-- 自動2色抽出JS -->
    <script>
    (() => {
      const frames = document.querySelectorAll('.media-frame.fill-gradient');
      frames.forEach(frame => {
        const img = frame.querySelector('img');
        if (!img) return;
        const apply = () => {
          try{
            const c = document.createElement('canvas'), ctx = c.getContext('2d');
            const w = c.width = 24, h = c.height = 24;
            ctx.drawImage(img, 0, 0, w, h);
            const {data} = ctx.getImageData(0,0,w,h);
            let lR=0,lG=0,lB=0,lN=0, rR=0,rG=0,rB=0,rN=0;
            for(let y=0;y<h;y++)for(let x=0;x<w;x++){
              const i=(y*w+x)*4, R=data[i], G=data[i+1], B=data[i+2];
              if(x<w/2){ lR+=R; lG+=G; lB+=B; lN++; } else { rR+=R; rG+=G; rB+=B; rN++; }
            }
            frame.style.setProperty('--c1',`rgb(${(lR/lN)|0},${(lG/lN)|0},${(lB/lN)|0})`);
            frame.style.setProperty('--c2',`rgb(${(rR/rN)|0},${(rG/rN)|0},${(rB/rN)|0})`);
          }catch(e){}
        };
        img.complete ? apply() : img.addEventListener('load', apply, {once:true});
      });
    })();
    </script>
</body>
</html>